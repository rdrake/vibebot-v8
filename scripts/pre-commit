#!/usr/bin/env bash
# Pre-commit hook: prevents commits with secrets, lint errors, or type issues

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

echo "Running pre-commit checks..."

# 1. Secrets detection with gitleaks
echo -n "Checking for secrets... "
if command -v gitleaks &> /dev/null; then
    if ! gitleaks git --staged --no-banner -v 2>/dev/null; then
        echo -e "${RED}FAILED${NC}"
        echo -e "${RED}Secrets detected! Remove them before committing.${NC}"
        exit 1
    fi
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${YELLOW}SKIPPED${NC} (gitleaks not installed)"
fi

# 2. Lint check
echo -n "Checking lint... "
if ! uv run ruff check . --quiet; then
    echo -e "${RED}FAILED${NC}"
    echo -e "${RED}Lint errors found. Run 'make lint' to see details.${NC}"
    exit 1
fi
echo -e "${GREEN}OK${NC}"

# 3. Format check
echo -n "Checking format... "
if ! uv run ruff format --check . --quiet; then
    echo -e "${RED}FAILED${NC}"
    echo -e "${RED}Formatting issues found. Run 'make format' to fix.${NC}"
    exit 1
fi
echo -e "${GREEN}OK${NC}"

# 4. Type check
echo -n "Checking types... "
if ! uv run ty check plugins/llm/src/ 2>/dev/null; then
    echo -e "${RED}FAILED${NC}"
    echo -e "${RED}Type errors found. Run 'make typecheck' to see details.${NC}"
    exit 1
fi
echo -e "${GREEN}OK${NC}"

# 5. Check for merge conflict markers
echo -n "Checking for merge conflicts... "
staged_files=$(git diff --cached --name-only)
if [ -n "$staged_files" ]; then
    conflict_files=$(echo "$staged_files" | xargs grep -l -E '^(<<<<<<<|=======|>>>>>>>)' 2>/dev/null || true)
    if [ -n "$conflict_files" ]; then
        echo -e "${RED}FAILED${NC}"
        echo -e "${RED}Merge conflict markers found in:${NC}"
        echo "$conflict_files"
        exit 1
    fi
fi
echo -e "${GREEN}OK${NC}"

# 6. Check for large files (>500KB)
echo -n "Checking file sizes... "
large_files=$(git diff --cached --name-only | while read file; do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file" 2>/dev/null || echo 0)
        if [ "$size" -gt 512000 ]; then
            echo "$file ($((size / 1024))KB)"
        fi
    fi
done)
if [ -n "$large_files" ]; then
    echo -e "${RED}FAILED${NC}"
    echo -e "${RED}Large files detected (>500KB):${NC}"
    echo "$large_files"
    exit 1
fi
echo -e "${GREEN}OK${NC}"

echo -e "${GREEN}All checks passed!${NC}"
